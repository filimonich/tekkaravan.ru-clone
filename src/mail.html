@@include("_head.html")
@@include("_header.html")

<div class="top mbt1">
  <div class="top__inner container">
    <div class="top__side breadcrumbs">
      <a class="breadcrumbs__item" href="./">Главная</a>
      <span class="breadcrumbs__item breadcrumbs__item_current">Рассылки на E-Mail</span>
    </div>
  </div>
</div>


<section class="section mb2">
  <div class="section__layout container">
    <div class="section__unit">
      <h2 class="title mb1">Рассылки на E-Mail</h2>
      <div class="form__buttons form__buttons_grid_whatsapp">
        <button class="form__button button form__button" type="button" data-toggle="modal"
          data-target="#email-templates">Шаблоны писем
        </button>
      </div>
      <form action="{{ url }}/emailhistory/id=<?= ($request['MAX(id)'] + 1) ?>" class="form mbt1 checkout-form"
        method="post" id="commentForm">
        <div class="form__body mb1">

          <label class="form__field form__field_txt mb1" data-title="Тема письма">
            <input name="subject" type="text" />
          </label>

          <!--<label class="form__field form__field_area form__field_wide" data-title="Текст сообщения">-->
          <textarea name="text" id="editor" placeholder="Текст сообщения" style="display: none;"></textarea>
          <!--</label>-->

          <select name="pages" id="emailPagesId" class="form__field form__field_sel form-s__item mt1">
            data-title="Форма оплаты" />
            <option disabled selected value="0">-- выберете базу --</option>
            <option value="ind">Указать почту</option>
            <option value="{{ data.title_en }}">{{ data.title_ru }}</option>
          </select>

          <div class="col-sm-12" id="email_input" style="display: none;">Email:
            <input name="email" type="text" class="form-control">
            <small>Укажите e-mail адреса через запятую</small>
          </div>

          <div class="col-sm-12" id="blocks_input">Блоки:
            <div id="emailSubPagesId">
              <select name="idBlockEmail" id="idBlockEmails">
                <option disabled selected value>Выберите блок</option>
              </select>
            </div>
          </div>

          <!-- <script src="{{ url }}/libs/ckeditor/ckeditor.js"></script>
          <script type="text/javascript">
            CKEDITOR.replace('editor', {
              language: 'ru',
              allowedContent: true,
              extraAllowedContent: '*{*}',
              fullPage: true,
              basicEntities: false
            });
          </script> -->

        </div>
        <div class="form__buttons form__buttons_grid col-12">
          <button class="form__button button button_send" name="submit" type="submit">Отправить</button>
        </div>
      </form>

    </div>
  </div>
</section>


<!-- Modal -->
<div class="modal fade" id="email-templates" tabindex="-1" role="dialog" aria-labelledby="Шаблоны писем"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Шаблоны писем</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body row">
        <div class="col-lg-4 col-sm-6 col-12">
          <!--<button type="button" loadhtml="mail-supplier" onclick="loadTemplate(this)">
				<div class="image"><img class="w-100" src="{{ url }}/bellatrix/email-templates/images/mail-supplier.png" alt=""></div>
				<div class="subtitle">Предложение поставщикам</div>
			</button>-->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<style>
  #email-templates .modal-dialog {
    max-width: 1100px;
  }

  #email-templates .modal-content {
    min-height: 75vh;
  }

  #email-templates .image {
    height: 200px;
    overflow-y: scroll;
  }

  #email-templates .subtitle {
    font-size: 20px;
    font-weight: 600;
    margin-top: 15px;
  }

  #email-templates .modal-body button {
    border: 2px solid #bec3c8 !important;
    box-shadow: 0 0 0 60px rgb(0 0 0 / 0%) inset, 0.1em 0.1em 0.2em #04080c !important;
    border-radius: 13px;
  }
</style>

<!-- Modal -->
<div class="modal modal2 fade" id="email-templates" tabindex="-1" role="dialog" aria-labelledby="Текст письма"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body row align-items-center">
        <div class="col-md-8 col-12">
          <h3>E-mail рассылка в процессе</h3>
          <p>Не закрывайте эту вкладку пока идет рассылка.</p>
          <p>По заверешию рассылки это окно закроется автоматически.</p>
        </div>
        <div class="col-md-4 col-12">
          <img src="/images/mail-download.gif" alt="">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- <script>
  const opt = document.querySelector('#emailPagesId');
  const blocks = document.querySelector('#blocks_input');
  const email = document.querySelector('#email_input');
  opt.value = "0";

  if (opt.value === "ind") {
    email.style.display = "block";
    blocks.style.display = "none";
  } else {
    email.style.display = "none";
    blocks.style.display = "block";
  }

  opt.addEventListener('change', (e) => {
    if (opt.value === "ind") {
      email.style.display = "block";
      blocks.style.display = "none";
    } else {
      email.style.display = "none";
      blocks.style.display = "block";
    }
  });

  function loadTemplate(item) {
    $.get(`/bellatrix/email-templates/files/${$(item).attr('loadhtml')}.html`).done(response => {
      CKEDITOR.instances['editor'].setData(response);
    }).fail();
    $('.modal').modal('hide')
  }

  let pageId;

  $('.checkout-form button[name="submit"]').click(function () {
    let ok = true;

    let sub = $('.checkout-form input[name="subject"]').val();
    let email = $('.checkout-form input[name="email"]').val();
    let text = CKEDITOR.instances.editor.getData();
    let block = $('.checkout-form select[name="idBlockEmail"]').val();
    let pages = $('.checkout-form select[name="pages"]').val();

    if (sub === "" || sub === null) {
      alert("Заполните тему письма");
      ok = false;
    }
    if (pages === "ind") {
      if (email === "" || email === null) {
        alert("Заполните почту");
        ok = false;
      }
    }
    if (pages !== "ind") {
      if (block === "" || block === null) {
        alert("Выберете блок для рассылки");
        ok = false;
      }
    }

    if (ok === true) {
      $.ajax({
        url: "/ajax/email_send.php",
        type: "post",
        dataType: "json",
        data: {
          "subject": sub,
          "email": email,
          "text": text,
          "block": block,
          "pages": pages
        },
        beforeSend: function () {
          $('.modal2').modal('show')
        },
        success: function (data) {
          pageId = data.pageId
        },
        complete: function () {
          $('.modal2').modal('hide')
          window.location.href = "https://tekkaravan.ru/?index=email_history_id?id=" + pageId;
        }
      });
    }
  })
</script> -->

<link rel="stylesheet" href="{{ url }}/style/css/select2.min.css">
<script src="{{ url }}/style/js/mailBlocks.js"></script>
<script src="{{ url }}/style/js/select2.min.js"></script>
<script src="{{ url }}/style/js/select2rulang.js"></script>
<script src="{{ url }}/assets/jquery.min.js"></script>

<!-- <script>

  $(document).ready(function () {
    $('#idBlockEmails').select2({
      language: "ru"
    });
  });

  $(document).on('select2:open', () => {
    document.querySelector('.select2-search__field').focus();
  });
</script> -->







@@include("_bottom.html")